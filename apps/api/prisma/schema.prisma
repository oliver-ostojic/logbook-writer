generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Role {
  id                  Int                   @id @default(autoincrement())
  storeId             Int?
  code                String                @unique
  displayName         String
  slotSizeMode        SlotSizeMode          @default(HOUR_ONLY)
  isUniversal         Boolean               @default(false)
  isCoverageRole      Boolean               @default(false)
  isBreakRole         Boolean               @default(false)
  isParkingRole       Boolean               @default(false)
  isConsecutive       Boolean               @default(false)
  minContinuousSlots  Int?
  maxContinuousSlots  Int?
  family              String?
  CoverageWindow      CoverageWindow[]
  CrewRole            CrewRole[]
  CrewRoleRequirement CrewRoleRequirement[]
  Store               Store?                @relation(fields: [storeId], references: [id])
}

model Store {
  id                  Int                   @id
  name                String
  timezone            String                @default("EST")
  startRegHour        Int                   @default(480)
  endRegHour          Int                   @default(1260)
  CoverageWindow      CoverageWindow[]
  Crew                Crew[]
  CrewRoleRequirement CrewRoleRequirement[]
  HourlyRequirement   HourlyRequirement[]
  logbooks            Logbook[]
  Role                Role[]
}

model Logbook {
  id             String        @id @db.Uuid
  date           DateTime
  storeId        Int
  status         LogbookStatus
  generatedAt    DateTime
  storedFilePath String?
  metadata       Json?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  store          Store         @relation(fields: [storeId], references: [id])
  Run            Run[]
  tasks          Task[]

  @@unique([storeId, date, status], name: "uniq_store_date_status")
}

model Task {
  id        String     @id @db.Uuid
  logbookId String     @db.Uuid
  crewId    String     @db.Char(7)
  type      TaskType
  startTime DateTime
  endTime   DateTime
  origin    TaskOrigin @default(ENGINE)
  locked    Boolean    @default(false)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  crew      Crew       @relation(fields: [crewId], references: [id])
  logbook   Logbook    @relation(fields: [logbookId], references: [id])

  @@index([crewId, startTime])
}

model Run {
  id             String    @id @db.Uuid
  date           DateTime
  storeId        Int
  engine         String
  seed           Int
  status         RunStatus
  runtimeMs      Int
  violations     Json
  objectiveScore Int?
  mipGap         Float?
  logbookId      String?   @db.Uuid
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  logbook        Logbook?  @relation(fields: [logbookId], references: [id])

  @@index([storeId, date])
}

model CoverageWindow {
  id              Int      @id @default(autoincrement())
  storeId         Int
  date            DateTime
  roleId          Int
  startHour       Int
  endHour         Int
  requiredPerHour Int      @default(1)
  createdAt       DateTime @default(now())
  updatedAt       DateTime
  Role            Role     @relation(fields: [roleId], references: [id])
  Store           Store    @relation(fields: [storeId], references: [id])

  @@unique([storeId, date, roleId])
  @@index([storeId, date])
}

model Crew {
  id                    String                   @id @db.Char(7)
  name                  String
  storeId               Int
  shiftStartMin         Int                   @default(0)
  shiftEndMin           Int                   @default(0)
  prefFirstHourWeight   Int                   @default(0)
  prefTaskWeight        Int                   @default(0)
  consecutiveProdWeight Int?
  consecutiveRegWeight  Int                   @default(0)
  prefBreakTiming       Int?
  prefBreakTimingWeight Int                   @default(0)
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  prefFirstHour         PrefenceTask?
  prefTask              PrefenceTask?
  Store                 Store                 @relation(fields: [storeId], references: [id])
  CrewRole              CrewRole[]
  CrewRoleRequirement   CrewRoleRequirement[]
  tasks                 Task[]
}

model CrewRole {
  crewId             String     @db.Char(7)
  roleId             Int
  roleName           String
  crewName           String
  assignedAt         DateTime   @default(now())
  specializationType String?
  Crew               Crew       @relation(fields: [crewId], references: [id])
  Role               Role       @relation(fields: [roleId], references: [id])

  @@id([crewId, roleId])
}

model CrewRoleRequirement {
  id            Int      @id @default(autoincrement())
  storeId       Int
  date          DateTime
  crewId        String     @db.Char(7)
  roleId        Int
  requiredHours Int
  createdAt     DateTime @default(now())
  updatedAt     DateTime
  Crew          Crew     @relation(fields: [crewId], references: [id])
  Role          Role     @relation(fields: [roleId], references: [id])
  Store         Store    @relation(fields: [storeId], references: [id])

  @@unique([storeId, date, crewId, roleId])
  @@index([storeId, date])
}

model HourlyRequirement {
  id                  Int      @id @default(autoincrement())
  storeId             Int
  date                DateTime
  hour                Int
  requiredRegister    Int      @default(0)
  requiredParkingHelm Int      @default(0)
  createdAt           DateTime @default(now())
  updatedAt           DateTime
  Store               Store    @relation(fields: [storeId], references: [id])

  @@unique([storeId, date, hour])
}

enum RunStatus {
  QUEUED
  RUNNING
  FEASIBLE
  OPTIMAL
  TIME_LIMIT
  INFEASIBLE
  FAILED
  CANCELED
}

enum LogbookStatus {
  DRAFT
  PUBLISHED
  SUPERSEDED
}

enum TaskType {
  REGISTER
  PRODUCT
  PARKING_HELM
  ORDER_WRITER
  ART
  MEAL_BREAK
  TRUCK
  DEMO
  WINE_DEMO
}

enum TaskOrigin {
  ENGINE
  MANUAL
  IMPORT
}

enum PrefenceTask {
  REGISTER
  PRODUCT
}

enum SlotSizeMode {
  HALF_HOUR_ONLY
  HOUR_ONLY
  HALF_OR_FULL
}
